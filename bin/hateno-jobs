#!/usr/bin/env python3
# -*- coding: utf-8 -*-

'''
This script uses the JobsManager class to manage the states of some jobs.
'''

import argparse

from hateno.errors import *
from hateno import jsonfiles
from hateno.jobs import JobsManager, JobState

def addArguments(parser):
	parser.add_argument('states_file', type = str, help = 'path to the file containing the states of the jobs to manage')
	parser.add_argument('mode', choices = ['get', 'set', 'steps', 'progress'], help = 'mode to use (get or set a state, get/set the total steps, get/set the finished steps)')
	parser.add_argument('job_name', type = str, help = 'name of the job')
	parser.add_argument('value', type = str, nargs = '?', help = 'value to set (new state for the job (in set mode), new number of steps)')

def action(args):
	jobs_manager = JobsManager()
	jobs_manager.linkToFile(args.states_file)

	jobs_descriptions = jobs_manager.getFileContent()
	jobs_manager.add(*jobs_descriptions.keys())

	jobs_manager.updateFromFile()

	if args.mode == 'set':
		try:
			state = JobState[(args.value or 'waiting').upper()]

		except KeyError:
			print('Unknown job state.')
			exit()

		try:
			jobs_manager.setJobState(args.job_name, state)

		except JobNotFoundError:
			jobs_manager.add(args.job_name)
			jobs_manager.setJobState(args.job_name, state)

	else:
		try:
			job = jobs_manager.getJob(args.job_name)

		except JobNotFoundError:
			print('The job has not been found.')
			exit()

		if args.mode == 'get':
			print(job.state.name)

		elif args.mode == 'steps':
			if args.value is None:
				print(job.total_steps)

			else:
				jobs_manager.setJobTotalSteps(args.job_name, int(args.value))

		elif args.mode == 'progress':
			if args.value is None:
				print(job.finished_steps)

			else:
				jobs_manager.setJobFinishedSteps(args.job_name, int(args.value))

if __name__ == '__main__':
	parser = argparse.ArgumentParser(description = 'Manage some jobs.')
	addArguments(parser)
	action(parser.parse_args())
